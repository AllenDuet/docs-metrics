{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "PCF Metrics deployment - Creates instances for all PCF Metrics components and hooks an ELB up to the Proxy instance.",
  "Parameters": {
    "InternalCIDR": {
      "Description": "(Optional, don't use for PCF installs) Internal subnet CIDR block.",
      "Type": "String"
    },
    "InternalRouteTableID": {
      "Description": "(Optional, don't use for PCF installs) The ID of the route table for the Internal Subnet.",
      "Type": "String"
    },
    "NamePrefix": {
      "Description": "The prefix to use for all instance names created by this deployment",
      "Type": "String",
      "Default": "metrix"
    },
    "VPCID": {
      "Description": "The ID of the deployment VPC",
      "Type": "AWS::EC2::VPC::Id"
    }
  },

  "Conditions": {
    "CreateInternalSubnet": {
      "Fn::And": [
        {
          "Fn::Not": [ { "Fn::Equals": [ { "Ref": "InternalCIDR" }, "" ] } ]
        },
        {
          "Fn::Not": [ { "Fn::Equals": [ { "Ref": "InternalRouteTableID" }, "" ] } ]
        }
      ]
    }
  },

  "Resources": {
    "InternalSubnet": {
      "Condition": "CreateInternalSubnet",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Select": [ "0", { "Fn::GetAZs": { "Ref": "AWS::Region" } } ]
        },
        "CidrBlock": { "Ref": "InternalCIDR" },
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Join": [ "-", [ { "Ref": "NamePrefix" }, "bosh-deploy-internal" ] ] }
          }
        ],
        "VpcId": { "Ref": "VPCID" }
      },
      "Type": "AWS::EC2::Subnet"
    },
    "InternalSubnetRouteTableAssociation": {
      "Condition": "CreateInternalSubnet",
      "Properties": {
        "RouteTableId": { "Ref": "InternalRouteTableID" },
        "SubnetId": { "Ref": "InternalSubnet" }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation"
    }
}
